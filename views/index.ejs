<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Welcome!</title>
  <link href='https://fonts.googleapis.com/css?family=Titillium+Web:400,300,600' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
  <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
  <script src="https://use.fontawesome.com/5c35264e88.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/style.css">
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="css/emojionearea.css">
  <script type="text/javascript" src="js/emojionearea.js"></script>
</head>

<body>
  <script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
  <script>
    var config = {
      apiKey: "AIzaSyASBt91td1rPD20gtX30jP4D3r2b7DGn7A",
      authDomain: "emojionary-eeafd.firebaseapp.com",
      databaseURL: "https://emojionary-eeafd.firebaseio.com",
      projectId: "emojionary-eeafd",
      storageBucket: "emojionary-eeafd.appspot.com",
      messagingSenderId: "222294226758",
    };
    firebase.initializeApp(config);
  </script>
  <div class="form">
    <div id="error" style="color:red;">
      <div class="field-wrap">
        <label textcolor="red">
          Sorry! This username already exists!
        </label>
        <br>
      </div>
    </div>
    <div id="loginSection">
      <h1>Welcome !</h1>
      <form action="/" id="loginForm">
        <div class="field-wrap">
          <input type="text" name="username" id="username" placeholder="Username" required autocomplete="off" />
        </div>
        <button type="submit" id="submit" class="button button-block" />Go On!</button>
      </form>
    </div>
    <!-- tab-content -->
    <div id="chooseMenuSection">
      <ul class="tab-group">
        <li class="tab active"><a href="#newRoomSection">New Room</a></li>
        <li class="tab" id="search"><a href="#searchRoomSection">Enter a room</a></li>
      </ul>
      <div class="tab-content">
        <div id="newRoomSection">
          <h1>Create a new room</h1>
          <form action="/newRoom" id="newRoomForm" method="post">
            <div class="top-row">
              <div class="field-wrap">
                <input type="text" id="roomName" required autocomplete="off" placeholder="Room Name" />
              </div>
              <div class="field-wrap">

                <input type="number" id="roomMax" required autocomplete="off" placeholder="Max people" />
              </div>
              <!-- add is private -->
              <br>
              <button type="submit" class="button button-block" />Create Room</button>
            </div>
          </form>
        </div>
        <div id="searchRoomSection">
          <br>
          <form action="/" method="post" id="searchform">
            <div class="field">
              <input type="text" id="searchterm" placeholder="Search room by Name, ID, creator..." />
              <button type="submit" onClick="" id="search">Find!</button>
            </div>
          </form>
          <br>
          <h1>Rooms: </h1>
          <table id="RoomSearchSectionTable" align="center" style="color:white;">
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- /form -->
  <div class="room">
    <div class="canvas" style="float:left;overflow:scroll">
      <button id="searchButton" style="width: 100%;background-color: transparent;border: 0;color: beige;"><i class="fa fa-arrow-down fa-2x" aria-hidden="true"></i></button>
      <div class="">
        <input type="text" name="spotlight" id="spotlight" placeholder="Spotlight Search" style="height: 2em;text-align: center;">

      </div>

      <div class="emoji">
        <% for(var i=43; i<images.length; i++) {%>
          <img src="<%= images[i] %>" class="emojis" title="<%=names[i] %>"></img>
          <% } %>
      </div>

      <script type="text/javascript">
      /*
      What is this shitty algorithm trying to accomplish ?
      1) Create emoji object which contains "Accuracy" & Emoji title which is seperated into name/value pair based on the number of spaces there are
      Example :
      SmileEmoji = {Accuracy:0,word_1:"smile",word_2:"face"}
      2)When user hits enter in the search bar :
        if emoji accuracy < 2 : the emoji will be displayed , otherwise it will be hidden
        How is emoji accuracy calculated ?
          for each word in emoji object
            compare it to search value => returns a value between 0 and 24 where 0 signifies that they are equal
          accuracy = returned value from each word / by number of words
      */
        var Emojis = []
        var EmojiElements = $('.emoji > img');
        console.log(EmojiElements)
        var EmojiID=0;
        $('.emoji > img').each(function() {
          var EmojiObject = {}
          $(this).attr("id",EmojiID)
          EmojiObject["ID"] = EmojiID
          EmojiID++
          var SplitString = $(this).attr("title").split(" ")
          EmojiObject["Accuracy"] = 0;
          for (var i = 0; i < SplitString.length; i++) {
            var namePair = "word_" + i
            var valuePair = SplitString[i]
            EmojiObject[namePair] = valuePair
          }
          Emojis.push(EmojiObject)
        });

        function levenshteinDistance(a, b) {
          if (a.length == 0) return b.length;
          if (b.length == 0) return a.length;
          var matrix = [];
          for (var i = 0; i <= b.length; i++) {
            matrix[i] = [i];
          }
          for (var j = 0; j <= a.length; j++) {
            matrix[0][j] = j;
          }
          for (var i = 1; i <= b.length; i++) {
            for (var j = 1; j <= a.length; j++) {
              if (b.charAt(i - 1) == a.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
              } else {
                matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, // substitution
                  Math.min(matrix[i][j - 1] + 1, // insertion
                    matrix[i - 1][j] + 1)); // deletion
              }
            }
          }
          return matrix[b.length][a.length];
        };

        $('#spotlight').on('keyup', function(e) {
          if (e.keyCode == 13) {
            if($('#spotlight').val() =="") {
              Emojis.forEach(function(EmojiObject) {$('#'+EmojiObject["ID"]).show()})
              return
            }
            Emojis.forEach(function(EmojiObject) {
              CalculateEmojiAccuracy($('#spotlight').val(),EmojiObject);
              if(EmojiObject["Accuracy"] <= 2) {
                $('#'+EmojiObject["ID"]).show()

              } else {
                $('#'+EmojiObject["ID"]).hide()
              }
            });
          }
        });

        function CalculateEmojiAccuracy(SearchValue,EmojiObject) {
          var ComparisonResults = []
          Object.keys(EmojiObject).forEach(function(key) {
            if(key != "Accuracy" && key != "ID") {
              ComparisonResults.push(levenshteinDistance(EmojiObject[key],SearchValue))
            }
          })
          var sum = 0;
          for(var g = 0;g < ComparisonResults.length;g++) {
            if(ComparisonResults[g]==1) {
              sum = 0;
              console.log(ComparisonResults[g]);
              break;
            } else {
              sum += ComparisonResults[g]
            }
          }
          EmojiObject["Accuracy"] = sum / ComparisonResults.length;
        }

        /*
          Time to fucking sort results by precision
          read inner html of the emoji div
          split every element and push it to an array : [<img>......</img>]
          sort array based on precision attribute
          convert array to string
          change emoji div inner html to returned string
          


         */
      </script>



      <div id="countdown"></div>
    </div>
    <div class="container" style="overflow-x:hidden;overflow-y:hidden;height:100%; width:30%; float:right;max-height:100vh;">
      <div class="row">
        <div class="panel panel-default" style="height:100vh margin-bottom:0;">
          <div class="panel-body">
            <div class="container" style="overflow-y:scroll;overflow-x:hidden;height:92vh;" id="chatbox">
            </div>
            <div class="panel-footer">
              <form id="chatform">
                <div class="input-group">
                  <input type="text" class="form-control" id="ChatInput" autocomplete="off">
                  <span class="input-group-btn">
                    <button class="btn btn-default" type="submit" id="ChatButton">Send</button>
                  </span>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="wordPopup" class="popup">
    <div class="popup-content">
      <div class="popup-header">
        <h2>Choose one of these words: </h2>
        <div id="timer"></div>
      </div>
      <div class="popup-body">
      </div>
    </div>
  </div>
  </div>
</body>
<script src="js/index.js"></script>

</html>
